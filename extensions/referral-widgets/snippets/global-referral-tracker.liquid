{% comment %}
  Catferrals Global Referral Tracker
  Handles referral tracking, verification, and dashboard functionality
  VERSION: 2.0.0
{% endcomment %}

<script>
(function() {
  'use strict';
  
  console.log('üîç Global Referral Tracker: Script loaded');
  console.log('üîç Global Referral Tracker: Current URL:', window.location.href);
  console.log('üîç Global Referral Tracker: Is theme editor:', window.location.href.includes('/admin/themes/'));
  
  // Only initialize once
  if (window.catferralsGlobalTrackerLoaded) {
    console.log('üîç Global Referral Tracker: Already loaded');
    return;
  }
  window.catferralsGlobalTrackerLoaded = true;
  console.log('üîç Global Referral Tracker: First initialization');

  // Store configuration
  const SHOP_DOMAIN = '{{ shop.permanent_domain }}';
  const CUSTOMER_EMAIL = '{{ customer.email | default: "" }}';
  const CUSTOMER_ID = '{{ customer.id | default: "" }}';

  // Check URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const verifyCode = urlParams.get('code');
  const verifyToken = urlParams.get('verify');
  const dashboardEmail = urlParams.get('dashboard');
  const referralCode = urlParams.get('ref');

  console.log('üîç Global Referral Tracker: URL Parameters:', {
    verifyCode,
    verifyToken,
    dashboardEmail,
    referralCode
  });

  // Track referral visit
  if (referralCode) {
    console.log('üîç Global Referral Tracker: Tracking referral visit', referralCode);
    fetch('/apps/referrals/track-visit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        code: referralCode,
        shop: SHOP_DOMAIN,
        url: window.location.href,
        timestamp: new Date().toISOString()
      })
    }).catch(err => console.error('üîç Global Referral Tracker: Track visit failed:', err));
  }

  // Handle verification
  if (verifyCode && verifyToken) {
    console.log('üîç Global Referral Tracker: Handling verification');
    handleReferrerVerification(verifyCode, verifyToken);
  }

  // Load dashboard
  if (dashboardEmail) {
    console.log('üîç Global Referral Tracker: Loading dashboard for', dashboardEmail);
    loadReferrerDashboard(dashboardEmail);
  }

  // Make global functions available
  window.catferralsOpenDashboard = openDashboard;
  window.catferralsVerifyReferrer = handleReferrerVerification;

  function handleReferrerVerification(code, token) {
    console.log('üîç Global Referral Tracker: Verifying referrer', code);
    
    // Create verification modal
    const modal = createModal();
    modal.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
        <h2 style="color: #333; margin-bottom: 16px;">Verifying your referral account...</h2>
        <p style="color: #666;">Please wait while we set up your dashboard.</p>
      </div>
    `;
    
    document.body.appendChild(modal);

    // Verify with backend
    fetch('/apps/referrals/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: code,
        verify: token,
        shop: SHOP_DOMAIN
      })
    })
    .then(response => response.json())
    .then(result => {
      console.log('üîç Global Referral Tracker: Verification result:', result);
      
      if (result.success) {
        showVerificationSuccess(modal, result);
      } else {
        showVerificationError(modal, result.error || 'Verification failed');
      }
    })
    .catch(err => {
      console.error('üîç Global Referral Tracker: Verification error:', err);
      showVerificationError(modal, 'Unable to verify account');
    });
  }

  function loadReferrerDashboard(email) {
    console.log('üîç Global Referral Tracker: Loading dashboard for:', email);
    
    const modal = createModal();
    modal.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
        <h2 style="color: #333; margin-bottom: 16px;">Loading your dashboard...</h2>
        <p style="color: #666;">Fetching your referral data...</p>
      </div>
    `;
    
    document.body.appendChild(modal);

    // Load dashboard data
    fetch('/apps/referrals/dashboard?email=' + encodeURIComponent(email))
      .then(response => response.json())
      .then(result => {
        console.log('üîç Global Referral Tracker: Dashboard data:', result);
        
        if (result.success) {
          showDashboard(modal, result.data);
          window.catferralsReferralData = result.data;
        } else {
          showDashboardError(modal, result.error || 'Failed to load dashboard');
        }
      })
      .catch(err => {
        console.error('üîç Global Referral Tracker: Dashboard error:', err);
        showDashboardError(modal, 'Unable to load dashboard');
      });
  }

  function createModal() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;
    
    const content = document.createElement('div');
    content.style.cssText = `
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    `;
    
    modal.appendChild(content);
    return content;
  }

  function showVerificationSuccess(modal, result) {
    modal.innerHTML = `
      <div style="padding: 40px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">üéâ</div>
        <h2 style="color: #333; margin-bottom: 16px;">Welcome to the Referral Program!</h2>
        <p style="color: #666; margin-bottom: 24px;">
          Your email has been verified successfully. You're now part of our referral program and can start earning commissions!
        </p>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <h3 style="color: #333; margin-bottom: 12px;">You're earning ${result.commissionRate || '10%'} on every referral!</h3>
        </div>
        <button onclick="catferralsOpenDashboard('${result.email}')" 
                style="background: #007ace; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin: 8px; font-size: 16px;">
          Access Your Dashboard
        </button>
        <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin: 8px; font-size: 16px;">
          Close
        </button>
      </div>
    `;
  }

  function showVerificationError(modal, error) {
    modal.innerHTML = `
      <div style="padding: 40px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
        <h2 style="color: #333; margin-bottom: 16px;">Verification Failed</h2>
        <p style="color: #666; margin-bottom: 24px;">${error}</p>
        <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
          Close
        </button>
      </div>
    `;
  }

  function showDashboard(modal, data) {
    modal.innerHTML = `
      <div style="padding: 32px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="color: #333; margin: 0;">Your Referral Dashboard</h2>
          <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                  style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
        </div>
        
        <!-- Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #007ace;">${data.totalReferrals || 0}</div>
            <div style="color: #666; font-size: 14px;">Total Referrals</div>
          </div>
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.totalClicks || 0}</div>
            <div style="color: #666; font-size: 14px;">Total Clicks</div>
          </div>
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">$${(data.totalCommissions || 0).toFixed(2)}</div>
            <div style="color: #666; font-size: 14px;">Total Earnings</div>
          </div>
        </div>
        
        <!-- Referral Link -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
          <h3 style="color: #333; margin-bottom: 16px;">Your Referral Link</h3>
          <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 1px solid #dee2e6;">
            <div style="font-family: monospace; font-size: 14px; word-break: break-all; color: #007ace;">
              ${data.referralLink || window.location.origin + '?ref=' + (data.code || 'YOUR_CODE')}
            </div>
          </div>
          <button onclick="navigator.clipboard.writeText('${data.referralLink || window.location.origin + '?ref=' + (data.code || 'YOUR_CODE')}'); alert('Link copied!')" 
                  style="background: #007ace; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; margin-right: 8px;">
            üìã Copy Link
          </button>
          <button onclick="shareReferralLink('${data.referralLink || window.location.origin + '?ref=' + (data.code || 'YOUR_CODE')}')" 
                  style="background: #28a745; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer;">
            üì± Share
          </button>
        </div>
      </div>
    `;
  }

  function showDashboardError(modal, error) {
    modal.innerHTML = `
      <div style="padding: 40px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
        <h2 style="color: #333; margin-bottom: 16px;">Dashboard Error</h2>
        <p style="color: #666; margin-bottom: 24px;">${error}</p>
        <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
          Close
        </button>
      </div>
    `;
  }

  function openDashboard(email) {
    if (!email) {
      email = prompt('Enter your email to access your referral dashboard:');
    }
    if (email) {
      loadReferrerDashboard(email);
    }
  }

  function shareReferralLink(link) {
    if (navigator.share) {
      navigator.share({
        title: 'Check out this store!',
        text: 'I found something you might like',
        url: link
      });
    } else {
      // Fallback - copy to clipboard
      navigator.clipboard.writeText(link).then(() => {
        alert('Link copied to clipboard!');
      });
    }
  }

  console.log('üîç Global Referral Tracker: Setup complete');
})();
</script> 