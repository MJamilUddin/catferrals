{% comment %}
  Catferrals Referral Widget
  A customizable referral widget that can be added to any theme section
  VERSION: 2.0.0
{% endcomment %}

{% render 'global-referral-tracker' %}

<div class="catferrals-referral-widget" 
     data-shop="{{ shop.permanent_domain }}"
     data-style="{{ block.settings.widget_style }}"
     data-position="{{ block.settings.widget_position }}"
     data-product-id="{{ product.id | default: '' }}"
     data-customer-email="{{ customer.email | default: '' }}"
     data-customer-id="{{ customer.id | default: '' }}">
  
  <!-- Widget Container -->
  <div id="catferrals-widget-container"></div>
</div>

<script>
(function() {
  'use strict';
  
  console.log('üîç Referral Widget: Initializing');
  
  function initializeWidget() {
    const container = document.getElementById('catferrals-widget-container');
    if (!container) return;
    
    const widgetElement = container.closest('.catferrals-referral-widget');
    const style = widgetElement?.dataset.style || 'modern';
    
    // Check if we have dashboard data from the global tracker
    if (window.catferralsReferralData) {
      renderDashboard(window.catferralsReferralData);
    } else {
      renderDefaultWidget(style);
    }
  }

  function renderDefaultWidget(style) {
    const container = document.getElementById('catferrals-widget-container');
    if (!container) return;

    let widgetHTML = '';
    if (style === 'modern') {
      widgetHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
          <div style="margin-bottom: 20px;">
            <h3 style="margin: 0 0 8px 0; font-size: 1.3rem;">üíù Share & Earn 10%</h3>
            <p style="margin: 0; opacity: 0.9;">Share with friends and earn commission on every sale!</p>
          </div>
          <button onclick="openReferrerDashboard()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">
            Join & Get Your Link
          </button>
        </div>
      `;
    } else {
      widgetHTML = `
        <div style="display: flex; align-items: center; gap: 12px; background: #f8f9fa; padding: 12px 16px; border-radius: 8px; border-left: 4px solid #667eea;">
          <span style="font-size: 1.2rem;">üîó</span>
          <span style="flex: 1;">Share this product & earn commission</span>
          <button onclick="openReferrerDashboard()" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Share</button>
        </div>
      `;
    }
    
    container.innerHTML = widgetHTML;
  }

  function renderDashboard(data) {
    const container = document.getElementById('catferrals-widget-container');
    if (!container) return;
    
    container.innerHTML = `
      <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div style="text-align: center; margin-bottom: 24px;">
          <h2 style="color: #333; margin: 0;">Your Referral Dashboard</h2>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #007ace;">${data.totalReferrals || 0}</div>
            <div style="color: #666;">Referrals</div>
          </div>
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #28a745;">$${(data.totalCommissions || 0).toFixed(2)}</div>
            <div style="color: #666;">Earned</div>
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Your Referral Link:</div>
          <div style="font-family: monospace; word-break: break-all; margin-bottom: 12px;">${data.referralLink || window.location.origin + '?ref=' + data.code}</div>
          <button onclick="navigator.clipboard.writeText('${data.referralLink || window.location.origin + '?ref=' + data.code}')" style="background: #007ace; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
            Copy Link
          </button>
        </div>
      </div>
    `;
  }

  // Initialize when ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeWidget);
  } else {
    initializeWidget();
  }
  
  // Global function to open dashboard
  window.openReferrerDashboard = function() {
    const email = prompt('Enter your email to access your referral dashboard:');
    if (email) {
      window.location.href = window.location.origin + '?dashboard=' + encodeURIComponent(email);
    }
  };
})();
</script>

{% schema %}
{
  "name": "Referral Widget",
  "target": "section",
  "settings": [
    {
      "type": "select",
      "id": "widget_style",
      "label": "Widget Style",
      "default": "modern",
      "options": [
        {"value": "modern", "label": "Modern"},
        {"value": "minimal", "label": "Minimal"}
      ]
    },
    {
      "type": "select",
      "id": "widget_position",
      "label": "Widget Position",
      "default": "center",
      "options": [
        {"value": "left", "label": "Left"},
        {"value": "center", "label": "Center"},
        {"value": "right", "label": "Right"}
      ]
    }
  ]
}
{% endschema %}
